<template>
    <div class="grid place-items-center items-start" style="opacity: 1;">
        <div class="transition-opacity">
            <div class="grid grid-cols-1 gap-1 py-8 max-w-[calc(100vw-2rem)] w-[36rem]">
                <div class="flex align-middle -mt-1 mb-6 mx-auto">
                    <div aria-label="Anthropic" class="h-4">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 143 16" width="143" height="16" preserveAspectRatio="xMidYMid meet" style="width: 100%; height: 100%; transform: translate3d(0px, 0px, 0px); content-visibility: visible;"><defs><clipPath id="__lottie_element_101"><rect width="143" height="16" x="0" y="0"></rect></clipPath><clipPath id="__lottie_element_103"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><g id="__lottie_element_107"><g style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(0,0,0)" fill-opacity="0" d=" M142.5,0 C142.5,0 142.5,16 142.5,16 C142.5,16 0,16 0,16 C0,16 0,0 0,0 C0,0 142.5,0 142.5,0z"></path></g></g></g><clipPath id="__lottie_element_111"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_116"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_125"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_134"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_143"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_152"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_161"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_170"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_179"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath><clipPath id="__lottie_element_188"><path d="M0,0 L143,0 L143,16 L0,16z"></path></clipPath></defs><g clip-path="url(#__lottie_element_101)"><g style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(249,249,247)" fill-opacity="0" d=" M142.5,0 C142.5,0 142.5,16 142.5,16 C142.5,16 0,16 0,16 C0,16 0,0 0,0 C0,0 142.5,0 142.5,0z"></path></g></g><g clip-path="url(#__lottie_element_103)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g clip-path="url(#__lottie_element_111)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g clip-path="url(#__lottie_element_188)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,18.299999237060547,0.27000001072883606)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M10.716191291809082,10.829001426696777 C10.716191291809082,10.829001426696777 3.756195545196533,0 3.756195545196533,0 C3.756195545196533,0 0,0 0,0 C0,0 0,15.470022201538086 0,15.470022201538086 C0,15.470022201538086 3.2038140296936035,15.470022201538086 3.2038140296936035,15.470022201538086 C3.2038140296936035,15.470022201538086 3.2038140296936035,4.6410064697265625 3.2038140296936035,4.6410064697265625 C3.2038140296936035,4.6410064697265625 10.163809776306152,15.470022201538086 10.163809776306152,15.470022201538086 C10.163809776306152,15.470022201538086 13.919991493225098,15.470022201538086 13.919991493225098,15.470022201538086 C13.919991493225098,15.470022201538086 13.919991493225098,0 13.919991493225098,0 C13.919991493225098,0 10.716191291809082,0 10.716191291809082,0 C10.716191291809082,0 10.716191291809082,10.829001426696777 10.716191291809082,10.829001426696777 C10.716191291809082,10.829001426696777 10.716191291809082,10.829001426696777 10.716191291809082,10.829001426696777z"></path></g></g></g><g clip-path="url(#__lottie_element_179)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,34.869998931884766,0.27000001072883606)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M0,2.983504056930542 C0,2.983504056930542 5.19273567199707,2.983504056930542 5.19273567199707,2.983504056930542 C5.19273567199707,2.983504056930542 5.19273567199707,15.470022201538086 5.19273567199707,15.470022201538086 C5.19273567199707,15.470022201538086 8.507256507873535,15.470022201538086 8.507256507873535,15.470022201538086 C8.507256507873535,15.470022201538086 8.507256507873535,2.983504056930542 8.507256507873535,2.983504056930542 C8.507256507873535,2.983504056930542 13.700006484985352,2.983504056930542 13.700006484985352,2.983504056930542 C13.700006484985352,2.983504056930542 13.700006484985352,0 13.700006484985352,0 C13.700006484985352,0 0,0 0,0 C0,0 0,2.983504056930542 0,2.983504056930542 C0,2.983504056930542 0,2.983504056930542 0,2.983504056930542z"></path></g></g></g><g clip-path="url(#__lottie_element_170)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,51.22999954223633,0.27000001072883606)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M10.605714797973633,6.165900230407715 C10.605714797973633,6.165900230407715 3.3142902851104736,6.165900230407715 3.3142902851104736,6.165900230407715 C3.3142902851104736,6.165900230407715 3.3142902851104736,0 3.3142902851104736,0 C3.3142902851104736,0 0,0 0,0 C0,0 0,15.470022201538086 0,15.470022201538086 C0,15.470022201538086 3.3142902851104736,15.470022201538086 3.3142902851104736,15.470022201538086 C3.3142902851104736,15.470022201538086 3.3142902851104736,9.149404525756836 3.3142902851104736,9.149404525756836 C3.3142902851104736,9.149404525756836 10.605714797973633,9.149404525756836 10.605714797973633,9.149404525756836 C10.605714797973633,9.149404525756836 10.605714797973633,15.470022201538086 10.605714797973633,15.470022201538086 C10.605714797973633,15.470022201538086 13.919991493225098,15.470022201538086 13.919991493225098,15.470022201538086 C13.919991493225098,15.470022201538086 13.919991493225098,0 13.919991493225098,0 C13.919991493225098,0 10.605714797973633,0 10.605714797973633,0 C10.605714797973633,0 10.605714797973633,6.165900230407715 10.605714797973633,6.165900230407715 C10.605714797973633,6.165900230407715 10.605714797973633,6.165900230407715 10.605714797973633,6.165900230407715z"></path></g></g></g><g clip-path="url(#__lottie_element_161)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,69.23999786376953,0.27000001072883606)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M3.3151700496673584,2.983504056930542 C3.3151700496673584,2.983504056930542 7.403865814208984,2.983504056930542 7.403865814208984,2.983504056930542 C9.03934097290039,2.983504056930542 9.901290893554688,3.5801939964294434 9.901290893554688,4.707304000854492 C9.901290893554688,5.834399700164795 9.03934097290039,6.431103706359863 7.403865814208984,6.431103706359863 C7.403865814208984,6.431103706359863 3.3151700496673584,6.431103706359863 3.3151700496673584,6.431103706359863 C3.3151700496673584,6.431103706359863 3.3151700496673584,2.983504056930542 3.3151700496673584,2.983504056930542 C3.3151700496673584,2.983504056930542 3.3151700496673584,2.983504056930542 3.3151700496673584,2.983504056930542z M13.216461181640625,4.707304000854492 C13.216461181640625,1.7900969982147217 11.072648048400879,0 7.558576583862305,0 C7.558576583862305,0 0,0 0,0 C0,0 0,15.470022201538086 0,15.470022201538086 C0,15.470022201538086 3.3151700496673584,15.470022201538086 3.3151700496673584,15.470022201538086 C3.3151700496673584,15.470022201538086 3.3151700496673584,9.414593696594238 3.3151700496673584,9.414593696594238 C3.3151700496673584,9.414593696594238 7.005825519561768,9.414593696594238 7.005825519561768,9.414593696594238 C7.005825519561768,9.414593696594238 10.321218490600586,15.470022201538086 10.321218490600586,15.470022201538086 C10.321218490600586,15.470022201538086 13.990056991577148,15.470022201538086 13.990056991577148,15.470022201538086 C13.990056991577148,15.470022201538086 10.319005966186523,8.953378677368164 10.319005966186523,8.953378677368164 C12.161579132080078,8.245061874389648 13.216461181640625,6.753532409667969 13.216461181640625,4.707304000854492 C13.216461181640625,4.707304000854492 13.216461181640625,4.707304000854492 13.216461181640625,4.707304000854492z"></path></g></g></g><g clip-path="url(#__lottie_element_152)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,84.98999786376953,0)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M7.622087478637695,12.906073570251465 C5.015110492706299,12.906073570251465 3.4244225025177,11.049725532531738 3.4244225025177,8.022093772888184 C3.4244225025177,4.95027494430542 5.015110492706299,3.0939269065856934 7.622087478637695,3.0939269065856934 C10.206976890563965,3.0939269065856934 11.775577545166016,4.95027494430542 11.775577545166016,8.022093772888184 C11.775577545166016,11.049725532531738 10.206976890563965,12.906073570251465 7.622087478637695,12.906073570251465 C7.622087478637695,12.906073570251465 7.622087478637695,12.906073570251465 7.622087478637695,12.906073570251465z M7.622087478637695,0 C3.1593029499053955,0 0,3.3149218559265137 0,8.022093772888184 C0,12.685078620910645 3.1593029499053955,16 7.622087478637695,16 C12.062784194946289,16 15.200028419494629,12.685078620910645 15.200028419494629,8.022093772888184 C15.200028419494629,3.3149218559265137 12.062784194946289,0 7.622087478637695,0 C7.622087478637695,0 7.622087478637695,0 7.622087478637695,0z"></path></g></g></g><g clip-path="url(#__lottie_element_143)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,103.29000091552734,0.27000001072883606)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M7.405848026275635,6.873104095458984 C7.405848026275635,6.873104095458984 3.3160574436187744,6.873104095458984 3.3160574436187744,6.873104095458984 C3.3160574436187744,6.873104095458984 3.3160574436187744,2.983504056930542 3.3160574436187744,2.983504056930542 C3.3160574436187744,2.983504056930542 7.405848026275635,2.983504056930542 7.405848026275635,2.983504056930542 C9.04176139831543,2.983504056930542 9.90394115447998,3.646505117416382 9.90394115447998,4.928304195404053 C9.90394115447998,6.2101030349731445 9.04176139831543,6.873104095458984 7.405848026275635,6.873104095458984 C7.405848026275635,6.873104095458984 7.405848026275635,6.873104095458984 7.405848026275635,6.873104095458984z M7.5605998039245605,0 C7.5605998039245605,0 0,0 0,0 C0,0 0,15.470022201538086 0,15.470022201538086 C0,15.470022201538086 3.3160574436187744,15.470022201538086 3.3160574436187744,15.470022201538086 C3.3160574436187744,15.470022201538086 3.3160574436187744,9.85659408569336 3.3160574436187744,9.85659408569336 C3.3160574436187744,9.85659408569336 7.5605998039245605,9.85659408569336 7.5605998039245605,9.85659408569336 C11.07561206817627,9.85659408569336 13.219999313354492,8.000200271606445 13.219999313354492,4.928304195404053 C13.219999313354492,1.8563942909240723 11.07561206817627,0 7.5605998039245605,0 C7.5605998039245605,0 7.5605998039245605,0 7.5605998039245605,0z"></path></g></g></g><g clip-path="url(#__lottie_element_134)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,128.0399932861328,0)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M10.914844512939453,10.5414400100708 C10.340370178222656,12.044201850891113 9.191434860229492,12.906073570251465 7.622706890106201,12.906073570251465 C5.0155181884765625,12.906073570251465 3.4246866703033447,11.049725532531738 3.4246866703033447,8.022093772888184 C3.4246866703033447,4.95027494430542 5.0155181884765625,3.0939269065856934 7.622706890106201,3.0939269065856934 C9.191434860229492,3.0939269065856934 10.340370178222656,3.9557981491088867 10.914844512939453,5.458559989929199 C10.914844512939453,5.458559989929199 14.427860260009766,5.458559989929199 14.427860260009766,5.458559989929199 C13.566211700439453,2.1436522006988525 10.981111526489258,0 7.622706890106201,0 C3.1595458984375,0 0,3.3149218559265137 0,8.022093772888184 C0,12.685078620910645 3.1595458984375,16 7.622706890106201,16 C11.003214836120605,16 13.588300704956055,13.834254264831543 14.449976921081543,10.5414400100708 C14.449976921081543,10.5414400100708 10.914844512939453,10.5414400100708 10.914844512939453,10.5414400100708 C10.914844512939453,10.5414400100708 10.914844512939453,10.5414400100708 10.914844512939453,10.5414400100708z"></path></g></g></g><g clip-path="url(#__lottie_element_125)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,117.83000183105469,0.27000001072883606)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M0,0 C0,0 6.1677093505859375,15.470022201538086 6.1677093505859375,15.470022201538086 C6.1677093505859375,15.470022201538086 9.550004005432129,15.470022201538086 9.550004005432129,15.470022201538086 C9.550004005432129,15.470022201538086 3.382294178009033,0 3.382294178009033,0 C3.382294178009033,0 0,0 0,0 C0,0 0,0 0,0z"></path></g></g></g><g clip-path="url(#__lottie_element_116)" style="display: block;" transform="matrix(1,0,0,1,0,0)" opacity="1"><g style="display: block;" transform="matrix(1,0,0,1,0,0.27000001072883606)" opacity="1"><g opacity="1" transform="matrix(1,0,0,1,0,0)"><path fill="rgb(24,24,24)" fill-opacity="1" d=" M5.824605464935303,9.348296165466309 C5.824605464935303,9.348296165466309 7.93500280380249,3.911694288253784 7.93500280380249,3.911694288253784 C7.93500280380249,3.911694288253784 10.045400619506836,9.348296165466309 10.045400619506836,9.348296165466309 C10.045400619506836,9.348296165466309 5.824605464935303,9.348296165466309 5.824605464935303,9.348296165466309 C5.824605464935303,9.348296165466309 5.824605464935303,9.348296165466309 5.824605464935303,9.348296165466309z M6.166755199432373,0 C6.166755199432373,0 0,15.470022201538086 0,15.470022201538086 C0,15.470022201538086 3.4480772018432617,15.470022201538086 3.4480772018432617,15.470022201538086 C3.4480772018432617,15.470022201538086 4.709278583526611,12.22130012512207 4.709278583526611,12.22130012512207 C4.709278583526611,12.22130012512207 11.16093635559082,12.22130012512207 11.16093635559082,12.22130012512207 C11.16093635559082,12.22130012512207 12.421928405761719,15.470022201538086 12.421928405761719,15.470022201538086 C12.421928405761719,15.470022201538086 15.87000560760498,15.470022201538086 15.87000560760498,15.470022201538086 C15.87000560760498,15.470022201538086 9.703250885009766,0 9.703250885009766,0 C9.703250885009766,0 6.166755199432373,0 6.166755199432373,0 C6.166755199432373,0 6.166755199432373,0 6.166755199432373,0z"></path></g></g></g></g></g></g></svg>
                    </div>
                </div>
                <h2 class="font-styrene-display text-center font-medium tracking-tighter mt-8 mb-8 sm:mb-12" 
                    style="font-size: clamp(1rem, 10vw, 3rem); line-height: 1em; word-break: break-words; letter-spacing: -.05em">
                    Welcome back, {{user.name}}
                </h2>
                <fieldset :disabled="isdisabled" class="
                    sm:sticky
                    sm:z-10
                    grid
                    px-6
                    sm:pr-3
                    sm:grid-flow-col
                    sm:grid-cols-[minmax(0,_1fr)_auto]
                    sm:gap-2
                    w-full
                    rounded-3xl
                    top-4
                    backdrop-blur-xl
                    z-10
                    shadow-element bg-white/50 hover:bg-white group 
                ">
                    <div class="flex items-center flex-grow overflow-x-hidden">
                        <div class="flex flex-col w-full">
                            <div class="overflow-y-auto w-full max-h-96 break-words py-4">
                                <div @keypress="keyMessage" contenteditable="true" translate="no" @input="messageInput" enterkeyhint="enter" tabindex="0" class="ProseMirror focus:outline-none">
                                    <p data-placeholder="Send a message or search past chats..." class="is-empty text-sm is-editor-empty before:!text-stone-400 before:whitespace-nowrap">
                                        <br class="ProseMirror-trailingBreak">
                                    </p>
                                </div>
                            </div>
                            <template v-if="uploadFileList.length>0">
                                <div class="flex flex-wrap gap-4 pb-4">
                                    <div v-for="(item, index) in uploadFileList" :key="item.file_etag" class="w-40 relative cursor-pointer rounded-md flex shadow-element text-xs bg-white" :aria-label="item.file_name" :title="item.file_name">
                                        <button @click="previewFile(item.file_etag, item.file_name, item.file_url)" aria-label="Preview contents" class="absolute inset-0 cursor-pointer hover:bg-black/5 w-40"></button>
                                        <div class="flex-shrink-0 w-12 h-12 bg-gigas-800 rounded-tl-md rounded-bl-md grid place-items-center text-white font-medium uppercase truncate" aria-hidden="true">{{item.file_format}}</div>
                                        <div class="py-2 px-3 min-w-0">
                                            <p class="truncate" :title="item.file_name">{{ item.file_name }}</p>
                                            <div class="text-gray-500">{{ returnFileSize(item.file_size) }}</div>
                                            <div @click="removeUploadFile(item.file_etag)" class="absolute top-0 right-0 bg-white shadow-element p-1 rounded-full cursor-pointer hover:bg-stone-100 translate-x-2 -translate-y-2 z-10">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111l63.51-63.52a12,12,0,0,1,17,17L145,128Z"></path></svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="grid grid-flow-col items-center gap-2 pb-3 place-self-end -mr-3 sm:pb-0 sm:place-self-auto sm:mr-0" 
                        style="grid-auto-columns: minmax(2rem, min-content);">
                        <label data-state="closed" class="
                            relative
                            grid
                            place-content-center
                            aspect-square
                            rounded-xl
                            cursor-pointer
                            bg-uivory-100
                            hover:bg-uivory-300/60
                            [fieldset:not(:disabled)_&amp;]:hover:bg-uivory-300
                            [fieldset:disabled_&amp;]:opacity-50
                            [fieldset:disabled_&amp;]:pointer-events-none
                            focus-within:ring"
                            >
                            <input :disabled="isUploadLoading" @change="uploadFiles" class="opacity-0 absolute inset-0 rounded-xl -z-10 overflow-hidden peer/upload" :accept="acceptFileTypes.join(',')" multiple="" type="file">
                            <div class="absolute -translate-y-12 -translate-x-16 top-0 left-0 text-xs min-w-max z-20 text-white rounded-md bg-black hidden peer-hover/upload:block px-3 py-1">Add files (5 max, 10MB each)<br>Accepts jpg, png, webp, etc.</div>
                            <template v-if="isUploadLoading">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path stroke-dasharray="60" stroke-dashoffset="60" stroke-opacity=".3" d="M12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3Z"><animate fill="freeze" attributeName="stroke-dashoffset" dur="1.3s" values="60;0"/></path><path stroke-dasharray="15" stroke-dashoffset="15" d="M12 3C16.9706 3 21 7.02944 21 12"><animate fill="freeze" attributeName="stroke-dashoffset" dur="0.3s" values="15;0"/><animateTransform attributeName="transform" dur="1.5s" repeatCount="indefinite" type="rotate" values="0 12 12;360 12 12"/></path></g></svg>
                            </template>
                            <template v-else>
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M208.25,123.76a6,6,0,0,1,0,8.49l-82.06,82a54,54,0,0,1-76.36-76.39L149.1,37.14a38,38,0,1,1,53.77,53.72L103.59,191.54a22,22,0,1,1-31.15-31.09l83.28-84.67a6,6,0,0,1,8.56,8.42L81,168.91a10,10,0,1,0,14.11,14.18L194.35,82.4a26,26,0,1,0-36.74-36.8L58.33,146.28a42,42,0,1,0,59.37,59.44l82.06-82A6,6,0,0,1,208.25,123.76Z"></path></svg>
                            </template>
                        </label>
                        <div>
                            <button :disabled="isdisabled" class="
                                w-full
                                flex
                                items-center
                                bg-uivory-100
                                py-2
                                px-2
                                rounded-full
                                cursor-pointer
                                shadow-element
                                transition-all
                                ease-in-out
                                active:scale-[0.98]
                                text-ellipsis
                                whitespace-nowrap
                                overflow-x-hidden
                                text-sm
                                shadow-element hover:bg-gigas-800 hover:text-white disabled:bg-gigas-500 disabled:text-white 
                                    group-hover:bg-gigas-800 group-hover:text-white group-disabled:bg-gigas-500 group-disabled:text-white" @click="submitTopic()">
                                    <div v-if="createChatButtonText" style="opacity: 1; width: auto;">
                                        <div class="px-2" style="font-size: 13px">{{createChatButtonText}}</div>
                                    </div>
                                    <div class="grid place-items-center w-5 h-5">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256"><path d="M232,127.89a16,16,0,0,1-8.18,14L55.91,237.9A16.14,16.14,0,0,1,48,240a16,16,0,0,1-15.05-21.34L60.3,138.71A4,4,0,0,1,64.09,136H136a8,8,0,0,0,8-8.53,8.19,8.19,0,0,0-8.26-7.47H64.16a4,4,0,0,1-3.79-2.7l-27.44-80A16,16,0,0,1,55.85,18.07l168,95.89A16,16,0,0,1,232,127.89Z"></path></svg>
                                    </div>
                            </button>
                        </div>
                    </div>
                </fieldset>
                <div style="--cmdk-list-height: 570.0px;">
                    <!-- 今天 -->
                    <template v-if="topicList.todayTopics.length>0">
                        <div>
                            <div data-header="" style="margin: 2rem 0px 1rem;font-size: 1.25rem;" aria-hidden="true" >Today</div>
                            <div  class="grid grid-cols-1 gap-y-2.5">
                                <div v-for="(item, index) in topicList.todayTopics" :key="item.id" class="relative
                                    bg-uivory-200 hover:bg-white
                                    py-3
                                    px-6
                                    rounded-full
                                    cursor-pointer
                                    shadow-element
                                    transition-transform
                                    ease-in-out
                                    active:scale-[0.98]
                                    text-ellipsis
                                    whitespace-nowrap
                                    overflow-x-hidden
                                ">
                                    <NuxtLink class="absolute inset-0" :to="'/topic/' + item.id">
                                        <span class="sr-only">{{ (!item.title || item.title.length==0)?"Untitled":item.title }}</span>
                                    </NuxtLink>
                                    <div class="flex">
                                        <div class="flex-none pr-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-2 -2 32 32"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M25 5H7a4 4 0 0 0-4 4v10a4 4 0 0 0 4 4h11l6 4v-4h1a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4Z"/><path d="M10 15a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm6 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm6 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0Z"/></g></svg>
                                        </div>
                                        <div class="flex-auto overflow-hidden whitespace-nowrap text-ellipsis">
                                            {{ (!item.title || item.title.length==0)?"Untitled":item.title }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- 最近一周 -->
                    <template v-if="topicList.weekTopics.length>0">
                        <div>
                            <div data-header="" style="margin: 2rem 0px 1rem;font-size: 1.25rem;" aria-hidden="true" >Last week</div>
                            <div class="grid grid-cols-1 gap-y-2.5">
                                <div v-for="(item, index) in topicList.weekTopics" :key="item.id" class="relative
                                    bg-uivory-200 hover:bg-white
                                    py-3
                                    px-6
                                    rounded-full
                                    cursor-pointer
                                    shadow-element
                                    transition-transform
                                    ease-in-out
                                    active:scale-[0.98]
                                    text-ellipsis
                                    whitespace-nowrap
                                    overflow-x-hidden
                                ">
                                    <NuxtLink class="absolute inset-0" :to="'/topic/' + item.id">
                                        <span class="sr-only">{{ (!item.title || item.title.length==0)?"Untitled":item.title }}</span>
                                    </NuxtLink>
                                    <div class="flex">
                                        <div class="flex-none pr-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-2 -2 32 32"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M25 5H7a4 4 0 0 0-4 4v10a4 4 0 0 0 4 4h11l6 4v-4h1a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4Z"/><path d="M10 15a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm6 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm6 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0Z"/></g></svg>
                                        </div>
                                        <div class="flex-auto overflow-hidden whitespace-nowrap text-ellipsis">
                                            {{ (!item.title || item.title.length==0)?"Untitled":item.title }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- 上个月 -->
                    <template v-if="topicList.monthTopics.length>0">
                        <div>
                            <div data-header="" style="margin: 2rem 0px 1rem;font-size: 1.25rem;" aria-hidden="true" >Last month</div>
                            <div class="grid grid-cols-1 gap-y-2.5">
                                <div v-for="(item, index) in topicList.monthTopics" :key="item.id" class="relative
                                    bg-uivory-200 hover:bg-white
                                    py-3
                                    px-6
                                    rounded-full
                                    cursor-pointer
                                    shadow-element
                                    transition-transform
                                    ease-in-out
                                    active:scale-[0.98]
                                    text-ellipsis
                                    whitespace-nowrap
                                    overflow-x-hidden
                                ">
                                    <NuxtLink class="absolute inset-0" :to="'/topic/' + item.id">
                                        <span class="sr-only">{{ (!item.title || item.title.length==0)?"Untitled":item.title }}</span>
                                    </NuxtLink>
                                    <div class="flex">
                                        <div class="flex-none pr-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-2 -2 32 32"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M25 5H7a4 4 0 0 0-4 4v10a4 4 0 0 0 4 4h11l6 4v-4h1a4 4 0 0 0 4-4V9a4 4 0 0 0-4-4Z"/><path d="M10 15a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm6 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm6 0a1 1 0 1 1-2 0a1 1 0 0 1 2 0Z"/></g></svg>
                                        </div>
                                        <div class="flex-auto overflow-hidden whitespace-nowrap text-ellipsis">
                                            {{ (!item.title || item.title.length==0)?"Untitled":item.title }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <button type="button" class=" peer fixed z-30
            top-3
            right-6
            rounded-full
            !p-0
            transition-transform
            ease-in-out
            active:scale-90
            focus:ring
            py-1
            px-2
            max-w-full
            whitespace-nowrap
            text-ellipsis
            overflow-hidden
            outline-none
            focus:backdrop-blur-xl
            hover:backdrop-blur-xl
            hover:bg-white/50 
            " id="menu-button" aria-expanded="true" aria-haspopup="true">
            <div class="font-bold rounded-full flex items-center justify-center text-white h-8 w-8 text-[14px] bg-gigas-900">{{ user.name?user.name.substring(0,1):user.username.substring(0,1) }}</div>
        </button>
        <div class="fixed p-1 hidden hover:block peer-focus:block top-10 right-6 z-30 mt-2 w-48 origin-top-right divide-y divide-gray-100 rounded-md bg-white shadow-element ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
          <div class="opacity-40 py-1.5 px-2 text-sm truncate" :title="user.username">{{ user.username }}</div>
          <div class="py-1" role="none">
            <a href="#" @click="openProfile = true" class="text-gray-700 block px-4 py-1.5 text-sm hover:bg-uivory-100 rounded" role="menuitem" tabindex="-1" id="menu-item-0">Account Settings</a>
            <a href="#" class="text-gray-700 block px-4 py-1.5 text-sm hover:bg-uivory-100 rounded" role="menuitem" tabindex="-1" id="menu-item-1">Help & Support</a>
          </div>
          <div class="py-1" role="none">
            <a href="#" @click="logout()" class="text-gray-700 block px-4 py-1.5 text-sm hover:bg-uivory-100 rounded" role="menuitem" tabindex="-1" id="menu-item-6">Log out</a>
          </div>
        </div>
        <!-- 用户设置Dialog -->
        <Profile v-model:open="openProfile"/>
        <!-- 文件预览Dialog -->
        <FilePreview ref="filePreview" v-model:open="openFilePreview" :fileEtag="fileEtag" :fileName="fileName" :fileUrl="fileUrl"/>
    </div>
</template>
<script setup>
import { ref } from 'vue'
import { useUserStore } from "~/stores/user"

definePageMeta({
    middleware: ['auth']
})
const router = useRouter()
const toast = useToast()
const useUser = useUserStore()
const user = useUser.user
const openProfile = ref(false)
const openFilePreview = ref(false)
const fileEtag = ref("")
const fileName = ref("")
const fileUrl = ref("")
const isdisabled = ref(false)
const isUploadLoading = ref(false)
const createChatButtonText = ref("Start a new chat")
const uploadFileList = ref([])
const acceptFileTypes = ref(
    ['.jpg', '.jpeg', '.png', '.webp', '.gif'
    // , '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.csv', '.pdf', '.txt', '.sql', 
    //  '.json', '.java', '.py', '.mq4', '.mq5', '.mqh', '.js', '.jsx', '.ts', '.tsx', '.log', '.html', '.htm', '.md', '.vue', '.rtf', 
    //  '.ipynb', '.css', '.cs', '.php', '.c', '.cpp', '.swift', '.go', '.scala', '.dart', '.lua', '.sh', '.bash', '.ini', '.config', 
    //  '.yaml', '.yml', '.bat'
    ])

const {data} = await useFetch(useRuntimeConfig().public.apiBase + "/topic/list", {
    method: 'get',
    headers: {"Authorization":"Bearer " + user.access_token},
    retry: false,
    onResponseError({ response }){
        if(response.status === 401){
            useUser.removeUser()
            router.push("/login")
        }else {
            toast.add({
                title: 'Server internal error.',
                description: response._data.detail,
                icon: 'i-heroicons-exclamation-triangle',
                color: 'red'
            })
        }
    }
})
const topicList = ref({})
searchTopicList(null)

async function submitTopic(){
    let title = document.querySelector(".ProseMirror").textContent
    if(/^\s*$/g.test(title)){
        title = null
    }
    await useFetch(useRuntimeConfig().public.apiBase + "/topic/create", {
        method: 'post',
        headers: {"Authorization":"Bearer " + user.access_token},
        retry: false,
        body:  {"title": title, "turn": 0, "attachs" : uploadFileList.value},
        onRequest({ request, options }) {
            isdisabled.value = true
        },
        async onResponse({ request, response, options }) {
            isdisabled.value = false
            if(response.ok === true){
                router.push("/topic/" + response._data.id)
            }else{
                if(response.status === 401){
                    useUser.removeUser()
                    router.push("/login")
                }else {
                    toast.add({
                        title: 'Server internal error.',
                        description: response._data.detail,
                        icon: 'i-heroicons-exclamation-triangle',
                        color: 'red'
                    })
                }
            }
        }
    })
}

function updateUserHeader(){
      document.getElementsByName("user-head").forEach(element => {
        element.innerHTML = user.name?user.name.substring(0,1):user.username.substring(0,1)
      })
    }
provide("updateUserHeader", updateUserHeader)

function messageInput(event){
    let last_p = event.target.lastChild
    if(!last_p){
        last_p = document.createElement('p')
        last_p.setAttribute("data-placeholder", "Send a message or search past chats...")
        last_p.setAttribute("class","is-empty is-editor-empty before:!text-stone-400 before:whitespace-nowrap")
        last_p.innerHTML = "<br class='ProseMirror-trailingBreak'>"
        event.target.appendChild(last_p)
        last_p.focus()
        let range = document.createRange();
        range.selectNodeContents(last_p);
        range.collapse(false);
        let selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        return
    }
    if(event.inputType === "insertCompositionText" || event.inputType === "insertText"){
        last_p.removeAttribute("class")
        last_p.removeAttribute("data-placeholder")
        let br = last_p.querySelector(".ProseMirror-trailingBreak")
        if(br){
            br.remove()
        }
        if(event.target.textContent.length>2){
            createChatButtonText.value = ""
        }
        searchTopicList(event.target.textContent)
    }else if(event.inputType === 'deleteContentBackward'){
        if(last_p.textContent.length===0){
            last_p.setAttribute("data-placeholder", "Send a message or search past chats...")
            last_p.setAttribute("class","is-empty is-editor-empty before:!text-stone-400 before:whitespace-nowrap")
        }
        if(!event.data){
            last_p.focus()
            let range = document.createRange();
            range.selectNodeContents(last_p);
            range.collapse(false);
            let selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range); 
        }
        if(event.target.textContent.length<=2){
            createChatButtonText.value = "Start a new chat"
        }
        searchTopicList(event.target.textContent)
    }else if(event.inputType === 'insertLineBreak'){
        last_p.removeAttribute("class")
        last_p.removeAttribute("data-placeholder")
    }else if(event.inputType === 'insertParagraph'){
        last_p.previousSibling.removeAttribute("class")
        last_p.previousSibling.removeAttribute("data-placeholder")
        if(last_p.previousSibling.textContent.length !== 0){
            let br = last_p.previousSibling.querySelector(".ProseMirror-trailingBreak")
            if(br){
                br.remove()
            }
        }
    }
}

function searchTopicList(keyword){
    if(!keyword || /^\s*$/g.test(keyword)){
        topicList.value["todayTopics"] = data.value.todayTopics.filter(t => true)
        topicList.value["weekTopics"] = data.value.weekTopics.filter(t => true)
        topicList.value["monthTopics"] = data.value.monthTopics.filter(t => true)
    }else{
        if(data.value.todayTopics && data.value.todayTopics.length>0){
            topicList.value["todayTopics"] = data.value.todayTopics.filter(t => t.title && t.title.includes(keyword))
        }else{
            topicList.value["todayTopics"] = []
        }
        if(data.value.weekTopics && data.value.weekTopics.length>0){
            topicList.value["weekTopics"] = data.value.weekTopics.filter(t => t.title && t.title.includes(keyword))
        }else{
            topicList.value["weekTopics"] = []
        }
        if(data.value.monthTopics && data.value.monthTopics.length>0){
            topicList.value["monthTopics"] = data.value.monthTopics.filter(t => t.title && t.title.includes(keyword))
        }else{
            topicList.value["monthTopics"] = []
        }
    }
}

function removeUploadFile(file_etag){
    uploadFileList.value = uploadFileList.value.filter((f) => f.file_etag !== file_etag)
}

function returnFileSize(number) {
  if (number < 1024) {
    return `${number} B`;
  } else if (number >= 1024 && number < 1048576) {
    return `${(number / 1024).toFixed(1)} KB`;
  } else if (number >= 1048576) {
    return `${(number / 1048576).toFixed(1)} MB`;
  }
}

async function uploadFiles(event){
    let files = event.target.files
    if(files.length===0){
        return
    }
    let remains = 5 - uploadFileList.value.length
    if(remains < files.length){
        toast.add({
            title: `Add files max 5`,
            icon: 'i-heroicons-exclamation-triangle',
            color: 'red'
        })
        return
    }
    let formData = new FormData()
    for(let f of files){
        if(f.size > 10*1024*1024){
            toast.add({
                title: `Each file size max 10MB`,
                description: `${f.name}`,
                icon: 'i-heroicons-exclamation-triangle',
                color: 'red'
            })
            return
        }
        let fileSuffix = f.name.substring(f.name.lastIndexOf('.'))
        if(!fileSuffix || !acceptFileTypes.value.includes(fileSuffix)){
            toast.add({
                title: `Unsupported file types`,
                description: `${f.name}`,
                icon: 'i-heroicons-exclamation-triangle',
                color: 'red'
            })
            return
        }
        formData.append("files", f)
    }
    await useFetch(useRuntimeConfig().public.apiBase + "/upload/files", {
        method: 'post',
        headers: {"Authorization":"Bearer " + user.access_token},
        retry: false,
        body: formData,
        onRequest({ request, options }) {
            isUploadLoading.value = true
        },
        async onResponse({ request, response, options }) {
            isUploadLoading.value = false
            uploadFileList.value = uploadFileList.value.concat(response._data)
        }
    })
}

function previewFile(file_etag, file_name, file_url){
    fileEtag.value = file_etag
    fileName.value = file_name
    fileUrl.value = file_url
    openFilePreview.value = true  
}

  // Send message to server
  async function keyMessage(event) {
    if(event.shiftKey===false && event.code==='Enter'){
      event.preventDefault()
      await submitTopic()
    }
  }

function logout(){
    useUser.removeUser()
    router.push("/login")
}

</script>